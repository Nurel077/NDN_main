<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тогуз коргоол</title>
  <link rel="stylesheet" href="games-theme.css">
</head>
<body>
  <main class="shell">
    <header class="topbar">
      <div class="brand" id="brand">Тогуз коргоол</div>
      <nav class="nav">
        <a href="games.html" id="navGames">Оюндар</a>
        <a href="index.html" id="navHome">Башкы бет</a>
        <a href="arkan-tartysh.html" id="navArkan">Аркан тартыш</a>
        <a href="jaa-atuu.html" id="navJaa">Жаа атуу</a>
        <a href="kok-boru.html" id="navKok">Кок-бору</a>
      </nav>
      <div class="lang-switch" id="langSwitch"></div>
    </header>

    <section class="game-wrap">
      <div class="game-head">
        <h1 id="title">Тогуз коргоол</h1>
        <p id="desc">Негизги эрежелер: себүү, кармоо жана түздүк. Оюн 2 оюнчуга бир браузерде.</p>
      </div>

      <div class="stats">
        <div class="stat" id="turn"></div>
        <div class="stat" id="kazan1"></div>
        <div class="stat" id="kazan2"></div>
        <div class="stat" id="tuzInfo"></div>
        <div class="stat" id="rec"></div>
      </div>

      <div class="panel">
        <p class="note" id="note"></p>
        <div class="board" id="board"></div>
        <div class="controls">
          <button id="resetBtn"></button>
          <strong id="status"></strong>
        </div>
        <div class="leaderboard">
          <h3 id="topTitle"></h3>
          <ol id="topList"></ol>
          <div class="controls">
            <button id="clearTopBtn"></button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="games-i18n.js"></script>
  <script>
    const T = {
      ky: {
        navGames: 'Оюндар', navHome: 'Башкы бет', navArkan: 'Аркан тартыш', navJaa: 'Жаа атуу', navKok: 'Кок-бору',
        title: 'Тогуз коргоол', desc: 'Негизги эрежелер: себүү, кармоо жана түздүк. Оюн 2 оюнчуга бир браузерде.',
        note: '1-оюнчу 1-9 уя, 2-оюнчу 10-18 уя. 9-уядан түздүк алынбайт.',
        turn: 'Жүрүш: {v}-оюнчу', kazan1: 'Казан 1: {v}', kazan2: 'Казан 2: {v}', tuzInfo: 'Түздүк: {a} / {b}', rec: 'Жеңиш: {a} - {b}',
        resetBtn: 'Жаңы оюн', live: 'Оюн жүрүп жатат', win1: '1-оюнчу жеңди', win2: '2-оюнчу жеңди', draw: 'Тең чыкты',
        topTitle: 'Топ-5 партия', clearTopBtn: 'Топту тазалоо', topEmpty: 'Азырынча жыйынтык жок', topEntry: '{i}) {v} казан'
      },
      ru: {
        navGames: 'Игры', navHome: 'Главная', navArkan: 'Аркан тартыш', navJaa: 'Жаа атуу', navKok: 'Кок-бору',
        title: 'Тогуз коргоол', desc: 'Базовые правила: раскладка, захват и туздук. Для 2 игроков на одном устройстве.',
        note: 'Игрок 1: лунки 1-9, игрок 2: 10-18. Из 9-й лунки туздук брать нельзя.',
        turn: 'Ход: игрок {v}', kazan1: 'Казан 1: {v}', kazan2: 'Казан 2: {v}', tuzInfo: 'Туздук: {a} / {b}', rec: 'Победы: {a} - {b}',
        resetBtn: 'Новая игра', live: 'Игра идет', win1: 'Победил игрок 1', win2: 'Победил игрок 2', draw: 'Ничья',
        topTitle: 'Топ-5 партий', clearTopBtn: 'Очистить топ', topEmpty: 'Пока нет результатов', topEntry: '{i}) {v} в казане'
      },
      en: {
        navGames: 'Games', navHome: 'Home', navArkan: 'Arkan Tartysh', navJaa: 'Jaa Atuu', navKok: 'Kok-boru',
        title: 'Toguz Korgool', desc: 'Core rules: sowing, captures and tuzduk. Local 2-player mode.',
        note: 'Player 1 uses pits 1-9, player 2 uses 10-18. Tuzduk is not allowed from 9th pit.',
        turn: 'Turn: player {v}', kazan1: 'Kazan 1: {v}', kazan2: 'Kazan 2: {v}', tuzInfo: 'Tuzduk: {a} / {b}', rec: 'Wins: {a} - {b}',
        resetBtn: 'New game', live: 'Game in progress', win1: 'Player 1 wins', win2: 'Player 2 wins', draw: 'Draw',
        topTitle: 'Top-5 Matches', clearTopBtn: 'Clear top', topEmpty: 'No results yet', topEntry: '{i}) {v} in kazan'
      }
    };

    const boardEl = document.getElementById('board');
    const turnEl = document.getElementById('turn');
    const kazan1El = document.getElementById('kazan1');
    const kazan2El = document.getElementById('kazan2');
    const tuzInfoEl = document.getElementById('tuzInfo');
    const statusEl = document.getElementById('status');
    const recEl = document.getElementById('rec');
    const topList = document.getElementById('topList');
    const topTitle = document.getElementById('topTitle');
    const clearTopBtn = document.getElementById('clearTopBtn');

    let pits, turn, kazan1, kazan2, tuz1, tuz2, over;
    const recKey = 'ndn_toguz_record_v2';
    const topKey = 'ndn_toguz_top5_v1';
    const rec = JSON.parse(localStorage.getItem(recKey) || '{"p1":0,"p2":0}');
    let top = JSON.parse(localStorage.getItem(topKey) || '[]');

    function tx(k, p) { return NDN.text(T, k, p); }
    function owner(i) { return i < 9 ? 1 : 2; }
    function isNinth(i) { return i === 8 || i === 17; }

    function setStaticText() {
      ['navGames','navHome','navArkan','navJaa','navKok','title','desc','note'].forEach((id) => {
        document.getElementById(id).textContent = tx(id);
      });
      document.getElementById('resetBtn').textContent = tx('resetBtn');
      topTitle.textContent = tx('topTitle');
      clearTopBtn.textContent = tx('clearTopBtn');
    }

    function renderTop() {
      topList.innerHTML = '';
      if (!top.length) {
        const li = document.createElement('li');
        li.textContent = tx('topEmpty');
        topList.appendChild(li);
        return;
      }
      top.forEach((value, idx) => {
        const li = document.createElement('li');
        li.textContent = tx('topEntry', { i: idx + 1, v: value });
        topList.appendChild(li);
      });
    }

    function addTop(value) {
      top.push(Math.max(0, Math.floor(value)));
      top = top.sort((a, b) => b - a).slice(0, 5);
      localStorage.setItem(topKey, JSON.stringify(top));
      renderTop();
    }

    function init() {
      pits = new Array(18).fill(9);
      turn = 1;
      kazan1 = 0;
      kazan2 = 0;
      tuz1 = -1;
      tuz2 = -1;
      over = false;
      statusEl.textContent = tx('live');
      render();
    }

    function pitTitle(i) {
      const number = i + 1;
      const tuz = (tuz1 === i) ? ' (T1)' : (tuz2 === i) ? ' (T2)' : '';
      return `${number}${tuz}\n${pits[i]}`;
    }

    function render() {
      boardEl.innerHTML = '';
      for (let i = 0; i < 18; i++) {
        const b = document.createElement('button');
        b.className = 'pit';
        if (tuz1 === i || tuz2 === i) b.classList.add('tuz');
        if (over || owner(i) !== turn || pits[i] === 0) b.classList.add('disabled');
        b.textContent = pitTitle(i);
        b.addEventListener('click', () => move(i));
        boardEl.appendChild(b);
      }

      turnEl.textContent = tx('turn', { v: turn });
      kazan1El.textContent = tx('kazan1', { v: kazan1 });
      kazan2El.textContent = tx('kazan2', { v: kazan2 });

      const t1 = tuz1 >= 0 ? (tuz1 + 1) : '-';
      const t2 = tuz2 >= 0 ? (tuz2 + 1) : '-';
      tuzInfoEl.textContent = tx('tuzInfo', { a: t1, b: t2 });
      recEl.textContent = tx('rec', { a: rec.p1, b: rec.p2 });
    }

    function sendStoneToTuz(index, player) {
      if (player === 1 && tuz1 === index) return 1;
      if (player === 2 && tuz2 === index) return 2;
      return 0;
    }

    function canTakeTuz(index, player) {
      if (isNinth(index)) return false;
      if (player === 1 && tuz1 !== -1) return false;
      if (player === 2 && tuz2 !== -1) return false;
      if (player === 1 && tuz2 !== -1 && (tuz2 % 9) === (index % 9)) return false;
      if (player === 2 && tuz1 !== -1 && (tuz1 % 9) === (index % 9)) return false;
      return true;
    }

    function finish() {
      const left = pits.slice(0, 9).reduce((a, b) => a + b, 0);
      const right = pits.slice(9).reduce((a, b) => a + b, 0);
      kazan1 += left;
      kazan2 += right;
      pits.fill(0);
      over = true;

      if (kazan1 > kazan2) {
        statusEl.textContent = tx('win1');
        rec.p1 += 1;
        addTop(kazan1);
      } else if (kazan2 > kazan1) {
        statusEl.textContent = tx('win2');
        rec.p2 += 1;
        addTop(kazan2);
      } else {
        statusEl.textContent = tx('draw');
        addTop(kazan1);
      }
      localStorage.setItem(recKey, JSON.stringify(rec));
      render();
    }

    function move(index) {
      if (over || owner(index) !== turn || pits[index] === 0) return;
      let stones = pits[index];
      pits[index] = 0;
      let pos = index;

      while (stones > 0) {
        pos = (pos + 1) % 18;
        const tuzOwner = sendStoneToTuz(pos, 1) || sendStoneToTuz(pos, 2);
        if (tuzOwner === 1) kazan1 += 1;
        else if (tuzOwner === 2) kazan2 += 1;
        else pits[pos] += 1;
        stones -= 1;
      }

      const landedOwner = owner(pos);
      const enemy = turn === 1 ? 2 : 1;
      if (landedOwner === enemy && sendStoneToTuz(pos, 1) === 0 && sendStoneToTuz(pos, 2) === 0) {
        if (pits[pos] === 3 && canTakeTuz(pos, turn)) {
          if (turn === 1) {
            tuz1 = pos;
            kazan1 += pits[pos];
          } else {
            tuz2 = pos;
            kazan2 += pits[pos];
          }
          pits[pos] = 0;
        } else if (pits[pos] % 2 === 0) {
          const captured = pits[pos];
          pits[pos] = 0;
          if (turn === 1) kazan1 += captured;
          else kazan2 += captured;
        }
      }

      const sum1 = pits.slice(0, 9).reduce((a, b) => a + b, 0);
      const sum2 = pits.slice(9).reduce((a, b) => a + b, 0);
      if (sum1 === 0 || sum2 === 0) {
        finish();
        return;
      }

      turn = enemy;
      render();
    }

    document.getElementById('resetBtn').addEventListener('click', init);
    clearTopBtn.addEventListener('click', () => {
      top = [];
      localStorage.setItem(topKey, JSON.stringify(top));
      renderTop();
    });
    NDN.mountLang('langSwitch', () => {
      setStaticText();
      if (!over) statusEl.textContent = tx('live');
      render();
      renderTop();
    });

    setStaticText();
    renderTop();
    init();
  </script>
</body>
</html>
